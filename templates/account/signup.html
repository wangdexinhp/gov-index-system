{% extends "base.html" %}

{% block title %}手机注册 - Django SaaS{% endblock %}

{% block content %}
<div class="flex items-center justify-center py-12 px-8">
  <div class="w-full max-w-md space-y-8">
    <div>
      <h2 class="mt-6 text-center text-3xl font-medium tracking-tighter text-black">
        手机号注册
      </h2>
      <p class="mt-2 text-center text-sm text-gray">
        或者
        <a href="{% url 'account_login' %}" class="font-medium text-black hover:text-dark-gray transition-all duration-300">
          登录已有账户
        </a>
      </p>
    </div>

    <form class="mt-8 space-y-6" method="POST" action="{% url 'account_signup' %}" id="register-form">
      {% csrf_token %}
      {% if redirect_field_value %}
      <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}" />
      {% endif %}

      <!-- 手机号字段 -->
      <div>
        <label for="id_mobile" class="block text-xs font-medium tracking-widest uppercase mb-1">手机号</label>
        <input id="id_mobile" name="mobile" type="tel" autocomplete="tel" required
               class="border-b-2 border-t-0 border-x-0 border-black p-3 w-full focus:border-dark-gray focus:outline-none"
               placeholder="请输入11位手机号"
               maxlength="11">
        <div id="mobile-error" class="text-red-600 text-xs mt-1 hidden"></div>
      </div>

      <!-- 短信验证码字段 -->
      <div class="flex space-x-4">
        <div class="flex-grow">
          <label for="id_sms_code" class="block text-xs font-medium tracking-widest uppercase mb-1">短信验证码</label>
          <input id="id_sms_code" name="sms_code" type="text" required maxlength="6"
                 class="border-b-2 border-t-0 border-x-0 border-black p-3 w-full focus:border-dark-gray focus:outline-none"
                 placeholder="请输入6位验证码">
        </div>
        <div class="flex-shrink-0 self-end">
          <button type="button" id="send-sms-btn"
                  class="border-b-2 border-black p-3 text-sm font-medium hover:text-dark-gray transition-all duration-300 whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed">
            获取验证码
          </button>
        </div>
      </div>

      <!-- 图形验证码字段 -->
      <div>
        <label class="block text-xs font-medium tracking-widest uppercase mb-1">图形验证码</label>

        <div class="flex items-center space-x-4">
          <!-- 验证码输入框容器（现在在左侧） -->
          <div class="flex-grow">
            <div class="flex flex-col space-y-2">
              <!-- 隐藏字段（存储captcha key） -->
              <input type="hidden" name="captcha_0" id="id_captcha_0" value="">

              <!-- 验证码输入框 -->
              <div>
                <input type="text" name="captcha_1" id="id_captcha_1"
                       autocomplete="off" required
                       class="border-b-2 border-t-0 border-x-0 border-black p-3 w-full focus:border-dark-gray focus:outline-none"
                       placeholder="输入验证码">
              </div>

              <!-- 刷新按钮和错误信息 -->
              <div class="flex justify-between items-center">
                <button type="button" onclick="loadNewCaptcha()"
                        class="text-sm text-gray-600 hover:text-black transition-colors duration-300 flex items-center">
                  <i class="fa-solid fa-rotate-right mr-1 text-xs"></i>换一张
                </button>
                <div id="captcha-error" class="text-red-600 text-xs hidden"></div>
              </div>
            </div>
          </div>

          <!-- 验证码图片容器（现在在右侧） -->
          <div class="flex-shrink-0 w-32">
            <div id="captcha-container" class="border border-gray-300 rounded-md p-1 bg-gray-50 h-16 flex items-center justify-center">
              <div id="captcha-loading" class="text-center text-gray-500 text-xs">
                加载中...
              </div>
              <img src="" alt="captcha"
                   id="captcha-image"
                   class="hidden w-full h-full object-contain cursor-pointer"
                   onclick="loadNewCaptcha()">
            </div>
          </div>
        </div>

        <!-- 错误显示 -->
        {% if form.captcha.errors %}
        <div class="text-red-600 text-sm mt-2">
          {% for error in form.captcha.errors %}
            <div>{{ error }}</div>
          {% endfor %}
        </div>
        {% endif %}
      </div>

      <!-- 密码字段 -->
      <div>
        <label for="id_password1" class="block text-xs font-medium tracking-widest uppercase mb-1">密码</label>
        <input id="id_password1" name="password1" type="password" autocomplete="new-password" required
               class="border-b-2 border-t-0 border-x-0 border-black p-3 w-full focus:border-dark-gray focus:outline-none"
               placeholder="密码（至少8位）">
      </div>

      <div>
        <label for="id_password2" class="block text-xs font-medium tracking-widest uppercase mb-1">确认密码</label>
        <input id="id_password2" name="password2" type="password" autocomplete="new-password" required
               class="border-b-2 border-t-0 border-x-0 border-black p-3 w-full focus:border-dark-gray focus:outline-none"
               placeholder="再次输入密码">
      </div>

      <!-- 其他错误显示 -->
      {% if form.errors %}
      <div class="border border-light-gray p-4 mt-6">
        <div class="flex">
          <i class="fa-solid fa-circle-exclamation text-black self-start mt-1"></i>
          <div class="ml-3">
            <h3 class="text-sm font-medium uppercase tracking-widest text-black">
              错误
            </h3>
            <div class="mt-2 text-sm text-gray">
              <ul class="list-disc pl-5 space-y-1">
                {% for field, errors in form.errors.items %}
                  {% if field != 'captcha' and field != 'captcha_0' and field != 'captcha_1' %}
                    {% for error in errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  {% endif %}
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <div>
        <button type="submit"
                class="relative w-full flex justify-center py-3 px-6 bg-black text-white hover:bg-dark-gray focus:outline-none transition-all duration-300 text-sm font-medium uppercase tracking-wider mt-8">
          <span class="absolute left-0 inset-y-0 flex items-center pl-3">
            <i class="fa-solid fa-user-plus"></i>
          </span>
          注册
        </button>
      </div>
    </form>
  </div>
</div>

<!-- JavaScript -->
<script>
// 加载新的验证码
async function loadNewCaptcha() {
    const loadingEl = document.getElementById('captcha-loading');
    const imageEl = document.getElementById('captcha-image');
    const errorEl = document.getElementById('captcha-error');
    const keyInput = document.getElementById('id_captcha_0');

    loadingEl.classList.remove('hidden');
    imageEl.classList.add('hidden');
    errorEl.classList.add('hidden');
    errorEl.textContent = '';

    try {
        const response = await fetch('/refresh-captcha/');

        if (!response.ok) {
            throw new Error(`请求失败: ${response.status}`);
        }

        const data = await response.json();

        if (data.status === 'success') {
            imageEl.src = '/captcha/image/' + data.key + '/';

            imageEl.onload = function() {
                loadingEl.classList.add('hidden');
                imageEl.classList.remove('hidden');
                keyInput.value = data.key;
            };

            imageEl.onerror = function() {
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.textContent = '图片加载失败，请重试';
            };
        } else {
            throw new Error(data.message || '服务器返回错误');
        }
    } catch (error) {
        console.error('加载验证码失败:', error);
        loadingEl.classList.add('hidden');
        errorEl.classList.remove('hidden');
        errorEl.textContent = '加载失败，请重试';
    }
}

// 检查手机号格式和是否已注册
async function checkMobile(mobile) {
    const mobileRegex = /^1[3-9]\d{9}$/;

    if (!mobileRegex.test(mobile)) {
        return { valid: false, message: '手机号格式不正确' };
    }

    // 可以在这里添加AJAX检查手机号是否已注册
    try {
        const response = await fetch('/check-mobile/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'mobile=' + encodeURIComponent(mobile)
        });

        const data = await response.json();
        if (data.status === 'error') {
            return { valid: false, message: data.msg };
        }
    } catch (error) {
        console.error('检查手机号失败:', error);
        // 如果检查失败，继续发送验证码（由后端再次验证）
    }

    return { valid: true, message: '' };
}

// 发送短信验证码
document.addEventListener('DOMContentLoaded', function() {
    const sendSmsBtn = document.getElementById('send-sms-btn');
    const mobileInput = document.getElementById('id_mobile');
    const mobileError = document.getElementById('mobile-error');

    // 页面加载时加载验证码
    setTimeout(loadNewCaptcha, 100);

    // 实时验证手机号格式
    if (mobileInput) {
        mobileInput.addEventListener('blur', async function() {
            const mobile = this.value;
            if (mobile.length === 11) {
                const result = await checkMobile(mobile);
                if (!result.valid) {
                    mobileError.textContent = result.message;
                    mobileError.classList.remove('hidden');
                } else {
                    mobileError.classList.add('hidden');
                }
            }
        });

        mobileInput.addEventListener('input', function() {
            mobileError.classList.add('hidden');
        });
    }

    // 发送短信验证码
    if (sendSmsBtn && mobileInput) {
        sendSmsBtn.addEventListener('click', async function() {
            const mobile = mobileInput.value;
            const btn = this;

            // 验证手机号格式
            const result = await checkMobile(mobile);
            if (!result.valid) {
                alert(result.message);
                return;
            }

            // 禁用按钮并显示加载状态
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = '发送中...';

            // 发送请求
            fetch('/send-sms-code/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: 'mobile=' + encodeURIComponent(mobile)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('验证码已发送，请注意查收');

                    // 开始倒计时
                    let countdown = 60;
                    const timer = setInterval(() => {
                        if (countdown <= 0) {
                            clearInterval(timer);
                            btn.textContent = '获取验证码';
                            btn.disabled = false;
                        } else {
                            btn.textContent = `重新发送(${countdown})`;
                            countdown--;
                        }
                    }, 1000);
                } else {
                    alert('发送失败: ' + data.msg);
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            })
            .catch(error => {
                alert('网络错误，请重试');
                btn.textContent = originalText;
                btn.disabled = false;
            });
        });
    }

    // 表单提交前验证
    const form = document.getElementById('register-form');
    if (form) {
        form.addEventListener('submit', async function(event) {
            const mobile = document.getElementById('id_mobile').value;
            const result = await checkMobile(mobile);

            if (!result.valid) {
                event.preventDefault();
                alert(result.message);
                return false;
            }

            // 自动生成一个email（如果用户没有输入）
            const emailInput = document.getElementById('id_email');
            if (!emailInput.value) {
                emailInput.value = mobile + '@mobile.user';
            }

            return true;
        });
    }
});
</script>
{% endblock %}