<!-- index_input/templates/index_input/manual_input.html -->
{% extends "index_input/base_input.html" %}

{% block input_content %}
<!-- 选择区域 -->
<div class="bg-white border border-light-gray rounded-lg p-6 mb-6">
    <h2 class="text-xl font-medium text-black mb-4">
        <i class="fa-solid fa-filter mr-2"></i>数据筛选条件
    </h2>

    <form id="filter-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- 年份选择 -->
        <div>
            <label class="block text-sm font-medium text-gray mb-2">
                <i class="fa-solid fa-calendar mr-1"></i>选择年份
            </label>
            <input type="number"
                   name="year"
                   id="year-input"
                   min="2000"
                   max="2100"
                   value="{{ current_year|default:2024 }}"
                   class="w-full px-3 py-2 border border-light-gray rounded-md focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent">
        </div>

        <!-- 省份选择 -->
        <div>
            <label class="block text-sm font-medium text-gray mb-2">
                <i class="fa-solid fa-map mr-1"></i>选择省份
            </label>
            <select name="province"
                    id="province-select"
                    class="w-full px-3 py-2 border border-light-gray rounded-md focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent">
                <option value="">请选择省份</option>
                {% for province in provinces %}
                <option value="{{ province.id }}">{{ province.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- 城市选择 -->
        <div>
            <label class="block text-sm font-medium text-gray mb-2">
                <i class="fa-solid fa-city mr-1"></i>选择城市
            </label>
            <select name="cities"
                    id="city-select"
                    multiple
                    class="w-full px-3 py-2 border border-light-gray rounded-md focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent h-32">
                <option value="">请先选择省份</option>
            </select>
            <div class="mt-1 text-xs text-gray">按住Ctrl键可多选</div>
        </div>

        <!-- 操作按钮 -->
        <div class="flex items-end">
            <button type="button"
                    onclick="loadData()"
                    class="w-full px-4 py-2 bg-black text-white hover:bg-dark-gray rounded-md font-medium">
                <i class="fa-solid fa-search mr-1"></i>加载数据
            </button>
        </div>
    </form>
</div>

<!-- 数据录入区域 -->
<div id="data-entry-section" class="hidden">
    <div class="bg-white border border-light-gray rounded-lg p-6 mb-4">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-medium text-black">
                <i class="fa-solid fa-edit mr-2"></i>指标数据录入
                <span class="text-sm font-normal text-gray ml-2" id="selected-info"></span>
            </h2>
            <div class="text-sm text-gray">
                共 <span class="font-medium">{{ total_indicators }}</span> 项指标
            </div>
        </div>

        <form method="post" id="data-form">
            {% csrf_token %}
            <input type="hidden" name="year" id="form-year">
            <input type="hidden" name="province" id="form-province">
            <input type="hidden" name="cities" id="form-cities">

            <!-- 指标数据表格 -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-light-gray">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray uppercase tracking-wider w-1/4">
                                指标名称
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray uppercase tracking-wider w-1/4">
                                本年指标值
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray uppercase tracking-wider w-1/4">
                                备注
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray uppercase tracking-wider w-1/4">
                                上一年参考值
                            </th>
                        </tr>
                    </thead>
                    <tbody id="indicators-tbody" class="divide-y divide-light-gray">
                        <!-- 指标数据将通过JavaScript动态加载 -->
                    </tbody>
                </table>
            </div>

            <!-- 操作按钮 -->
            <div class="mt-8 pt-6 border-t border-light-gray flex justify-end space-x-4">
                <button type="button"
                        onclick="resetForm()"
                        class="px-6 py-2 border border-black text-black hover:bg-light-gray rounded-md font-medium">
                    <i class="fa-solid fa-rotate-left mr-1"></i>重置
                </button>
                <button type="submit"
                        class="px-6 py-2 bg-black text-white hover:bg-dark-gray rounded-md font-medium">
                    <i class="fa-solid fa-floppy-disk mr-1"></i>提交数据
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 空状态提示 -->
<div id="empty-state" class="text-center py-12">
    <div class="w-16 h-16 mx-auto mb-4 border-2 border-light-gray rounded-full flex items-center justify-center">
        <i class="fa-solid fa-database text-gray text-2xl"></i>
    </div>
    <h3 class="text-lg font-medium text-gray mb-2">请选择年份、省份和城市</h3>
    <p class="text-gray">选择筛选条件后点击"加载数据"开始录入</p>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
let allIndicators = [];

// 初始化页面
document.addEventListener('DOMContentLoaded', function() {
    // 加载指标数据
    loadIndicators();

    // 监听省份选择
    document.getElementById('province-select').addEventListener('change', function() {
        loadCitiesByProvince(this.value);
    });
});

// 加载所有指标
async function loadIndicators() {
    try {
        const response = await fetch('/api/indicators/');
        allIndicators = await response.json();
    } catch (error) {
        console.error('加载指标失败:', error);
    }
}

// 根据省份加载城市
async function loadCitiesByProvince(provinceId) {
    if (!provinceId) return;

    const citySelect = document.getElementById('city-select');
    citySelect.innerHTML = '<option value="">加载中...</option>';

    try {
        const response = await fetch(`/index_input/get-cities/?province_id=${provinceId}`);
        const data = await response.json();

        citySelect.innerHTML = '';
        data.cities.forEach(city => {
            const option = document.createElement('option');
            option.value = city.id;
            option.textContent = city.name;
            citySelect.appendChild(option);
        });
    } catch (error) {
        console.error('加载城市失败:', error);
        citySelect.innerHTML = '<option value="">加载失败</option>';
    }
}

// 加载数据
async function loadData() {
    const year = document.getElementById('year-input').value;
    const provinceId = document.getElementById('province-select').value;
    const citySelect = document.getElementById('city-select');
    const selectedCities = Array.from(citySelect.selectedOptions).map(opt => opt.value);

    if (!year || !provinceId || selectedCities.length === 0) {
        alert('请选择年份、省份和至少一个城市');
        return;
    }

    showLoading('正在加载数据...');

    try {
        // 更新表单隐藏字段
        document.getElementById('form-year').value = year;
        document.getElementById('form-province').value = provinceId;
        document.getElementById('form-cities').value = JSON.stringify(selectedCities);

        // 更新显示信息
        const provinceName = document.getElementById('province-select').selectedOptions[0].text;
        const cityNames = Array.from(citySelect.selectedOptions).map(opt => opt.text);
        document.getElementById('selected-info').textContent =
            `${year}年 ${provinceName} ${cityNames.join('、')}`;

        // 加载并显示指标表格
        await renderIndicatorsTable(year, selectedCities);

        // 显示数据录入区域
        document.getElementById('data-entry-section').classList.remove('hidden');
        document.getElementById('empty-state').style.display = 'none';

    } catch (error) {
        console.error('加载数据失败:', error);
        alert('加载数据失败，请重试');
    } finally {
        hideLoading();
    }
}

// 渲染指标表格
async function renderIndicatorsTable(year, cityIds) {
    const tbody = document.getElementById('indicators-tbody');
    tbody.innerHTML = '';

    for (let i = 0; i < allIndicators.length; i++) {
        const indicator = allIndicators[i];
        const row = document.createElement('tr');
        row.className = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';

        // 获取上一年数据（这里简化处理，实际应从服务器获取）
        let previousValue = '';
        if (cityIds.length === 1) {
            // 如果只选择一个城市，可以尝试获取上一年数据
            try {
                const response = await fetch(
                    `/index_input/get-previous-data/?year=${year}&city_id=${cityIds[0]}&indicator_id=${indicator.id}`
                );
                const data = await response.json();
                previousValue = data.value ? formatNumber(data.value) : '';
            } catch (error) {
                console.error('获取上一年数据失败:', error);
            }
        }

        row.innerHTML = `
            <td class="px-4 py-3">
                <input type="hidden" name="indicators-${i}-indicator_id" value="${indicator.id}">
                <input type="text"
                       name="indicators-${i}-indicator_name"
                       value="${indicator.name}"
                       class="w-full px-3 py-2 bg-gray-100 border border-light-gray rounded-md" readonly>
            </td>
            <td class="px-4 py-3">
                <input type="number"
                       name="indicators-${i}-value"
                       step="0.01"
                       class="w-full px-3 py-2 border border-light-gray rounded-md focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent"
                       placeholder="请输入指标值">
            </td>
            <td class="px-4 py-3">
                <textarea
                    name="indicators-${i}-note"
                    rows="2"
                    class="w-full px-3 py-2 border border-light-gray rounded-md focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent"
                    placeholder="请输入备注"></textarea>
            </td>
            <td class="px-4 py-3">
                <input type="text"
                       value="${previousValue}"
                       class="w-full px-3 py-2 bg-gray-50 border border-light-gray rounded-md" readonly>
            </td>
        `;

        tbody.appendChild(row);
    }
}

// 重置表单
function resetForm() {
    if (confirm('确定要重置所有输入的数据吗？')) {
        const inputs = document.querySelectorAll('#data-form input[type="number"], #data-form textarea');
        inputs.forEach(input => {
            input.value = '';
        });
    }
}
</script>
{% endblock %}