

<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>数据录入系统</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
<style>
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body class="bg-gray-900 min-h-screen">
<!-- 导航栏 -->
<header class="bg-gray-900 border-b border-yellow-600 h-20 flex items-center px-8 sticky top-0 z-50">
<div class="flex items-center space-x-3">
<iconify-icon class="text-yellow-500 text-3xl" icon="mdi:chart-box"></iconify-icon>
<h1 class="text-2xl font-bold text-white">数据指标管理系统</h1>
</div>
<div class="ml-auto flex items-center space-x-4">
<div class="flex space-x-3 mr-6">
  <a href="/dashboard/" 
      class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-gray-900 font-medium py-2 px-4 rounded-lg text-sm hover:from-yellow-600 hover:to-yellow-700 transition">
      指标录入系统
  </a>
  <a href="/dashboard/query/" 
      class="bg-gray-700 text-white font-medium py-2 px-4 rounded-lg text-sm hover:bg-gray-600 border border-gray-600 transition">
      指标查询系统
  </a>
</div>
<div class="text-right">
<p class="text-white text-sm">管理员</p>
<p class="text-gray-400 text-xs">admin@datasys.com</p>
</div>
<div class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center">
<iconify-icon class="text-yellow-500 text-xl" icon="mdi:account"></iconify-icon>
</div>
</div>
</header>
<!-- 主内容区 -->
<main class="max-w-7xl mx-auto px-6 py-8">
<!-- 选择区域 -->
<div class="bg-gray-800 border border-yellow-600 rounded-xl p-6 mb-8">
<div class="grid grid-cols-1 md:grid-cols-6 gap-6">
<div>
<label class="block text-sm font-medium text-yellow-500 mb-2">选择年份</label>
<div class="relative">
<select class="w-full bg-gray-700 border border-gray-600 rounded-lg py-3 px-4 text-white focus:border-yellow-500 focus:ring-2 focus:ring-yellow-900 outline-none">
<option>2025年</option>
<option>2024年</option>
<option>2023年</option>
</select>
</div>
</div>
        <div>
          <label class="block text-sm font-medium text-yellow-500 mb-2">选择省份</label>
          <div class="relative">
            <select id="province-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-3 px-4 text-white focus:border-yellow-500 focus:ring-2 focus:ring-yellow-900 outline-none">
              <option value="">-- 请选择省份 --</option>
              <option value="北京市">北京市</option>
              <option value="天津市">天津市</option>
              <option value="上海市">上海市</option>
              <option value="重庆市">重庆市</option>
              <option value="河北省">河北省</option>
              <option value="山西省">山西省</option>
              <option value="辽宁省">辽宁省</option>
              <option value="吉林省">吉林省</option>
              <option value="黑龙江省">黑龙江省</option>
              <option value="江苏省">江苏省</option>
              <option value="浙江省">浙江省</option>
              <option value="安徽省">安徽省</option>
              <option value="福建省">福建省</option>
              <option value="江西省">江西省</option>
              <option value="山东省">山东省</option>
              <option value="河南省">河南省</option>
              <option value="湖北省">湖北省</option>
              <option value="湖南省">湖南省</option>
              <option value="广东省">广东省</option>
              <option value="海南省">海南省</option>
              <option value="四川省">四川省</option>
              <option value="贵州省">贵州省</option>
              <option value="云南省">云南省</option>
              <option value="陕西省">陕西省</option>
              <option value="甘肃省">甘肃省</option>
              <option value="青海省">青海省</option>
              <option value="内蒙古自治区">内蒙古自治区</option>
              <option value="广西壮族自治区">广西壮族自治区</option>
              <option value="西藏自治区">西藏自治区</option>
              <option value="宁夏回族自治区">宁夏回族自治区</option>
              <option value="新疆维吾尔自治区">新疆维吾尔自治区</option>
              <option value="香港特别行政区">香港特别行政区</option>
              <option value="澳门特别行政区">澳门特别行政区</option>
            </select>
          </div>
        </div>
        <div class="min-w-0">
          <label class="block text-sm font-medium text-yellow-500 mb-2">选择城市 (多选)</label>
          <div id="city-list" class="bg-gray-700 border border-gray-600 rounded-lg p-2 max-h-40 overflow-y-auto max-w-sm">
            <div class="flex justify-end mb-2 space-x-2">
              <button type="button" id="select-all-cities" class="text-xs text-gray-300 hover:text-white">全选</button>
              <button type="button" id="deselect-all-cities" class="text-xs text-gray-300 hover:text-white">取消全选</button>
            </div>
            <div class="space-y-2" id="city-items">
              <!-- 城市项由前端渲染 -->
            </div>
            <div id="city-empty" class="text-gray-400 text-sm p-2 hidden">无可选城市</div>
          </div>
        </div>
<div class="min-w-0 overflow-hidden">
  <label class="block text-sm font-medium text-yellow-500 mb-2">指标组</label>
  <div class="relative">
    <select class="w-full bg-gray-700 border border-gray-600 rounded-lg py-3 px-4 text-white focus:border-yellow-500 focus:ring-2 focus:ring-yellow-900 outline-none" id="indicator-filter">
      <!-- <option value="">全部指标</option>
      <option value="population">人口相关</option>
      <option value="enterprise">企业相关</option>
      <option value="technology">技术创新</option>
      <option value="employment">就业相关</option>
      <option value="budget">预算支出</option> -->
  <option value="admin" selected>行政区域数据</option>
      <option value="population">人口数据</option>
      <option value="economy_structure">经济结构数据</option>
      <option value="education_tech">教育科技数据</option>
      <option value="employment">就业数据</option>
      <option value="finance">财政指标数据</option>
      <option value="economic_performance">经济效果数据</option>
      <option value="ecology">生态环保数据</option>
      <option value="market_supervision">市场监管数据</option>
      <option value="social_security">社会保障数据</option>
      <option value="healthcare">医疗卫生数据</option>
      <option value="infrastructure">基础设施数据</option>
      <option value="public_safety">公共安全数据</option>
      <option value="culture_sports">文化体育数据</option>
      <option value="administrative_integrity">行政廉洁数据</option>
      <option value="economic_growth">经济增长数据</option>
      <option value="economic_development">经济发展数据</option>
      <option value="public_service">公共服务数据</option>
      <option value="law_based_governance">依法行政数据</option>
      <option value="government_affairs_openness">政务公开数据</option>
    </select>
  </div>
</div>

<!-- 二级筛选（多选）：仅在选择区域新增一列，初始内容由一级选择填充 -->
<div class="min-w-0 overflow-hidden">
  <label class="block text-sm font-medium text-yellow-500 mb-2">筛选指标（多选）</label>
  <div class="relative">
    <!-- replaced native multi-select with checkbox panel for easier multi-select UX -->
    <div id="indicator-subfilter" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 max-h-40 overflow-y-auto"></div>
  </div>
</div>
</div>
</div>
<p class="text-xs text-gray-400 mt-3">当前日期: 2025年12月11日</p>
</div>
<!-- 录入进度显示 -->
<div class="bg-gradient-to-r from-gray-800 to-gray-750 border border-yellow-500 rounded-xl p-4 mb-8">
<div class="flex items-center justify-between">
<div class="flex items-center space-x-3">
<iconify-icon class="text-yellow-500 text-2xl" icon="mdi:progress-clock"></iconify-icon>
<div>
<p class="text-sm text-gray-300">数据录入进度</p>
<p class="text-lg font-bold text-yellow-400" id="progress-text">进度：已完成0/48指标</p>
</div>
</div>
<div class="w-64 h-3 bg-gray-700 rounded-full overflow-hidden">
<div class="h-full bg-gradient-to-r from-yellow-500 to-yellow-400 rounded-full transition-all duration-300" id="progress-bar" style="width: 0%"></div>
</div>
</div>
</div>
<!-- 功能选项卡 -->
<div class="mb-6 border-b border-gray-700">
<div class="flex space-x-8">
<button class="pb-3 px-1 font-medium text-white border-b-2 border-yellow-500" id="manual-tab">手工录入</button>
<button class="pb-3 px-1 font-medium text-gray-400" id="excel-tab">Excel上传</button>
</div>
</div>
<!-- 手工录入区域 -->
<!-- 手工录入区域 -->
<form id="manual-form" method="post" action="/dashboard/submit/">
      {% csrf_token %}  
  <div class="bg-gray-800 border border-yellow-600 rounded-xl p-6 mb-8" id="manual-section">
<div class="max-h-[60vh] overflow-x-auto overflow-y-auto hide-scrollbar pb-4">
<table class="w-full border-collapse">
<thead>
<tr class="bg-gray-700 sticky top-0">
<th class="border border-gray-600 px-4 py-3 text-left text-yellow-500 font-medium min-w-24">城市</th>
<th class="border border-gray-600 px-4 py-3 text-left text-yellow-500 font-medium" colspan="4" data-indicator="常住人口数">常住人口数</th>
<th class="border border-gray-600 px-4 py-3 text-left text-yellow-500 font-medium" colspan="4" data-indicator="高新技术企业产值">高新技术企业产值</th>
<th class="border border-gray-600 px-4 py-3 text-left text-yellow-500 font-medium" colspan="4" data-indicator="专利授权数量">专利授权数量</th>
<th class="border border-gray-600 px-4 py-3 text-left text-yellow-500 font-medium" colspan="4" data-indicator="教育支出">教育支出</th>
</tr>
<tr class="bg-gray-700 sticky top-12">
<th class="border border-gray-600 px-2 py-2 text-left text-gray-300 font-normal text-xs min-w-20"></th>
<th class="border border-gray-600 px-2 py-2 text-left text-gray-300 font-normal text-xs min-w-20">数值</th>
<th class="border border-gray-600 px-2 py-2 text-left text-gray-300 font-normal text-xs min-w-20">备注</th>
<th class="border border-gray-600 px-2 py-2 text-left text-gray-300 font-normal text-xs min-w-20">数据来源</th>
<th class="border border-gray-600 px-2 py-2 text-left text-gray-300 font-normal text-xs min-w-20">去年参考</th>
</tr>
</thead>
<tbody>


  
</tr>
          </tbody>
        </table>
        <!-- Hidden JSON payload for backend -->
        <input type="hidden" id="rows-json" name="rows_json" value="" />
      </div>
    </div>
<!-- Excel上传区域 -->
<div class="bg-gray-800 border border-yellow-600 rounded-xl p-6 mb-8 hidden" id="excel-section">
<div class="text-center py-12">
<div class="mx-auto w-20 h-20 flex items-center justify-center bg-gray-700 rounded-full mb-6">
<iconify-icon class="text-green-500 text-4xl" icon="mdi:file-excel"></iconify-icon>
</div>
<h3 class="text-xl text-white mb-3">上传Excel数据文件</h3>
<p class="text-gray-400 mb-8">支持.xlsx格式文件，请确保数据格式符合要求</p>
<div class="border-2 border-dashed border-gray-600 rounded-xl max-w-xl mx-auto p-10 bg-gray-700">
<div class="flex flex-col items-center">
<iconify-icon class="text-yellow-500 text-4xl mb-4" icon="mdi:cloud-upload"></iconify-icon>
<p class="text-gray-400 mb-2">拖放文件到此处</p>
<p class="text-gray-500 text-sm mb-4">或</p>
<button class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-gray-900 font-medium py-2 px-6 rounded-lg">
              选择文件
            </button>
</div>
</div>
<div class="mt-8">
<button class="flex items-center text-yellow-500 mx-auto">
<iconify-icon class="mr-2" icon="mdi:download"></iconify-icon>
            下载Excel模板
          </button>
</div>
</div>
</div>
<!-- 操作按钮 -->
<div class="flex space-x-4">
      <button id="submit-button" type="submit" class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-gray-900 font-medium py-3 px-8 rounded-lg text-lg">
        提交数据
      </button>
<button id="reset-button" type="button" class="bg-transparent border border-gray-600 text-white font-medium py-3 px-8 rounded-lg text-lg">
        重置表单
      </button>
<button id="save-draft-button" type="button" class="ml-auto bg-gray-700 border border-gray-600 text-white font-medium py-3 px-6 rounded-lg flex items-center">
<iconify-icon class="mr-2" icon="mdi:content-save"></iconify-icon>
        保存草稿
      </button>
</div>
</form>
</main>
<script>
    // 计算总指标数和更新进度的函数
      function updateProgress() {
      // 只统计“数值”和“备注”字段（通过 placeholder 选择，避免把“去年参考”计入）
      const allInputs = document.querySelectorAll('#manual-section table tbody input[placeholder="数值"], #manual-section table tbody input[placeholder="备注"]');
      const totalIndicators = allInputs.length;

      // 统计有值的输入框
      let completedIndicators = 0;
      allInputs.forEach(input => {
        if (input.value.trim() !== '') {
          completedIndicators++;
        }
      });
      
      // 更新进度文本和进度条
      const progressText = document.getElementById('progress-text');
      const progressBar = document.getElementById('progress-bar');
      
      if (totalIndicators > 0) {
        const percentage = (completedIndicators / totalIndicators) * 100;
        progressText.textContent = `进度：已完成${completedIndicators}/${totalIndicators}指标`;
        progressBar.style.width = percentage + '%';
      }
    }

    // 为所有输入框添加事件监听
    function attachProgressListeners() {
      // 仅为“数值”和“备注”字段添加监听
      const inputs = document.querySelectorAll('#manual-section table tbody input[placeholder="数值"], #manual-section table tbody input[placeholder="备注"]');
      inputs.forEach(input => {
        input.addEventListener('input', updateProgress);
        input.addEventListener('change', updateProgress);
      });
    }

    // 页面加载时初始化进度
    document.addEventListener('DOMContentLoaded', function() {
      updateProgress();
      attachProgressListeners();
    });

    // 省份->城市联动：前端渲染城市列表并根据省份过滤（不依赖后端）
    (function() {
      const provinceCityMap = {
        '北京市': ['北京市'],
        '天津市': ['天津市'],
        '上海市': ['上海市'],
        '重庆市': ['重庆市'],
        '河北省': ['石家庄','唐山','秦皇岛','邯郸','保定'],
        '山西省': ['太原','大同','运城','临汾'],
        '辽宁省': ['沈阳','大连','鞍山','营口','锦州'],
        '吉林省': ['长春','吉林','四平','辽源'],
        '黑龙江省': ['哈尔滨','齐齐哈尔','牡丹江','佳木斯'],
        '江苏省': ['南京','苏州','无锡','常州','南通'],
        '浙江省': ['杭州','宁波','温州','绍兴','金华'],
        '安徽省': ['合肥','芜湖','蚌埠','阜阳'],
        '福建省': ['福州','厦门','泉州','漳州'],
        '江西省': ['南昌','赣州','九江','上饶'],
        '山东省': ['济南','青岛','烟台','淄博','潍坊'],
        '河南省': ['郑州','洛阳','开封','南阳'],
        '湖北省': ['武汉','宜昌','襄阳','黄石'],
        '湖南省': ['长沙','株洲','湘潭','衡阳'],
        '广东省': ['广州市','深圳市','珠海','佛山','东莞'],
        '海南省': ['海口','三亚'],
        '四川省': ['成都','绵阳','德阳','南充'],
        '贵州省': ['贵阳','遵义','安顺'],
        '云南省': ['昆明','大理','玉溪'],
        '陕西省': ['西安','咸阳','宝鸡'],
        '甘肃省': ['兰州','天水','酒泉'],
        '青海省': ['西宁'],
        '内蒙古自治区': ['呼和浩特','包头','鄂尔多斯'],
        '广西壮族自治区': ['南宁','桂林','柳州','北海'],
        '西藏自治区': ['拉萨'],
        '宁夏回族自治区': ['银川'],
        '新疆维吾尔自治区': ['乌鲁木齐','克拉玛依'],
        '香港特别行政区': ['香港'],
        '澳门特别行政区': ['澳门']
      };

      function renderCitiesForProvince(prov) {
        const container = document.getElementById('city-items');
        const empty = document.getElementById('city-empty');
        container.innerHTML = '';
        const cities = prov && prov !== '' ? (provinceCityMap[prov] || []) : Object.values(provinceCityMap).flat();
        if (!cities || cities.length === 0) {
          empty.classList.remove('hidden');
          return;
        }
        empty.classList.add('hidden');
        cities.forEach(city => {
          const id = 'city-' + city.replace(/\s|市/g, '');
          const div = document.createElement('div');
          div.className = 'flex items-center';
          const input = document.createElement('input');
          input.type = 'checkbox';
          input.className = 'rounded border-gray-600 text-yellow-500 city-checkbox';
          input.value = city;
          input.id = id;
          const label = document.createElement('label');
          label.htmlFor = id;
          label.className = 'ml-2 text-white';
          label.textContent = city;
          div.appendChild(input);
          div.appendChild(label);
          container.appendChild(div);
        });
      }

      function getSelectedCities() {
        const checks = Array.from(document.querySelectorAll('.city-checkbox'));
        const selected = checks.filter(c => c.checked).map(c => c.value);
        // 如果没有选择城市，返回空数组（不再默认返回全部城市）
        return selected;
      }

      function renderTableRows() {
        const tbodySelector = document.querySelector('#manual-section table tbody');
        if (!tbodySelector) return;
        const tbody = tbodySelector;
        tbody.innerHTML = '';
        const cities = getSelectedCities();

          // calculate current number of indicator groups from header
          const headers = document.querySelectorAll('#manual-section table thead th[data-indicator]');
          const groups = headers ? headers.length : 0;

          if (!cities || cities.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 1 + groups * 4;
            td.className = 'text-center text-gray-400 p-4';
            td.textContent = '未找到要录入的城市';
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
          }

          // If there are cities but no selected indicators, show an instruction row
          if (groups === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 1; // only city column exists
            td.className = 'text-left text-gray-400 p-4';
            td.textContent = '请先在“筛选指标（多选）”中选择一个或多个指标，选中后将显示相应的录入列。';
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
          }

          cities.forEach(city => {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-600 hover:bg-gray-700 transition';
            const tdCity = document.createElement('td');
            tdCity.className = 'border border-gray-600 px-4 py-3 text-white font-medium bg-gray-750';
            tdCity.textContent = city;
            tr.appendChild(tdCity);

            // For each indicator group render: value, note, source, last-year reference (4 cells per group)
            for (let group = 0; group < groups; group++) {
              const tdVal = document.createElement('td');
              tdVal.className = 'border border-gray-600 px-2 py-2';
              // sanitize city and indicator to build safe names
              const indicatorName = headers[group] ? headers[group].getAttribute('data-indicator') || ('indicator' + group) : ('indicator' + group);
              const sanitize = (s) => ('' + s).replace(/\s+/g, '_').replace(/[^\w\-]/g, '').toLowerCase();
              const cityKey = sanitize(city);
              const indKey = sanitize(indicatorName);
              const valueName = 'data[' + cityKey + '][' + indKey + '][value]';
              tdVal.innerHTML = '<input name="' + valueName + '" class="w-full bg-gray-600 border border-gray-500 rounded px-1 py-1 text-white text-xs focus:border-yellow-500 focus:ring-1 focus:ring-yellow-900 outline-none" placeholder="数值" type="text"/>';
              tr.appendChild(tdVal);

              const tdNote = document.createElement('td');
              tdNote.className = 'border border-gray-600 px-2 py-2';
              const noteName = 'data[' + cityKey + '][' + indKey + '][note]';
              tdNote.innerHTML = '<input name="' + noteName + '" class="w-full bg-gray-600 border border-gray-500 rounded px-1 py-1 text-white text-xs focus:border-yellow-500 focus:ring-1 focus:ring-yellow-900 outline-none" placeholder="备注" type="text"/>';
              tr.appendChild(tdNote);

              const tdSource = document.createElement('td');
              tdSource.className = 'border border-gray-600 px-2 py-2';
              const sourceName = 'data[' + cityKey + '][' + indKey + '][source]';
              tdSource.innerHTML = '<select name="' + sourceName + '" class="w-full bg-gray-600 border border-gray-500 rounded px-1 py-1 text-white text-xs focus:border-yellow-500 focus:ring-1 focus:ring-yellow-900 outline-none">\n<option value="">选择来源</option>\n<option value="CITY_STAT_YB">地市统计年鉴</option>\n<option value="CITY_YB">地市年鉴</option>\n<option value="CITY_DEV_BUL">地市级发展公报</option>\n<option value="CITY_GOV_RPT">地市级政府工作报告</option>\n<option value="PROV_STAT_YB">省级统计年鉴</option>\n<option value="PROV_YB">省级年鉴</option>\n<option value="PROF_YB">专业年鉴</option>\n<option value="SPECIAL_RPT">专项报告</option>\n<option value="GOV_INFO_RPT">政府信息公开报告</option>\n</select>';
              tr.appendChild(tdSource);

              const tdRef = document.createElement('td');
              tdRef.className = 'border border-gray-600 px-2 py-2';
              const refName = 'data[' + cityKey + '][' + indKey + '][reference]';
              // tdRef.innerHTML = '<input name="' + refName + '" class="w-full bg-gray-600 border border-gray-500 rounded px-1 py-1 text-white text-xs focus:border-yellow-500 focus:ring-1 focus:ring-yellow-900 outline-none" placeholder="去年参考" type="text"/>';
              tdRef.innerHTML = '<div class="text-white text-xs px-1">-</div>';

              tr.appendChild(tdRef);
            }

            tbody.appendChild(tr);
          });

        // Attach progress listeners to new inputs
        attachProgressListeners();
        updateProgress();

        // Enable/disable submit button depending on whether there are rows
        const submitBtn = document.getElementById('submit-button');
        if (submitBtn) submitBtn.disabled = !(cities && cities.length > 0);
      }

      // Build table headers dynamically given an array of indicator names
      function buildTableHeaders(indicators) {
        const thead = document.querySelector('#manual-section table thead');
        if (!thead) return;
        const firstRow = thead.querySelector('tr:first-child');
        const secondRow = thead.querySelector('tr:nth-child(2)');

        // first row: city + indicator ths (colspan=4)
        firstRow.innerHTML = '';
        const thCity = document.createElement('th');
        thCity.className = 'border border-gray-600 px-4 py-3 text-left text-yellow-500 font-medium min-w-24';
        thCity.textContent = '城市';
        firstRow.appendChild(thCity);

        indicators.forEach(ind => {
          const th = document.createElement('th');
          th.className = 'border border-gray-600 px-4 py-3 text-left text-yellow-500 font-medium';
          th.colSpan = 4;
          th.setAttribute('data-indicator', ind);
          th.textContent = ind;
          firstRow.appendChild(th);
        });

        // second row: blank + 4 sub-headers per indicator
        secondRow.innerHTML = '';
        const thEmpty = document.createElement('th');
        thEmpty.className = 'border border-gray-600 px-2 py-2 text-left text-gray-300 font-normal text-xs min-w-20';
        secondRow.appendChild(thEmpty);
        indicators.forEach(() => {
          ['数值', '备注', '数据来源', '去年参考'].forEach(title => {
            const th = document.createElement('th');
            th.className = 'border border-gray-600 px-2 py-2 text-left text-gray-300 font-normal text-xs min-w-20';
            th.textContent = title;
            secondRow.appendChild(th);
          });
        });
      }

      // expose functions so outside code (indicator filter) can rebuild headers
      window.buildTableHeaders = buildTableHeaders;
      window.renderTableRows = renderTableRows;

      document.addEventListener('DOMContentLoaded', function() {
        // capture the initial indicators from the static header so we can restore later
        const existingHeaders = Array.from(document.querySelectorAll('#manual-section table thead th[data-indicator]')).map(h => h.getAttribute('data-indicator'));
        window.initialIndicators = existingHeaders || [];

        const provSel = document.getElementById('province-select');
        if (!provSel) return;
        // initial render: all cities
        renderCitiesForProvince('');
        provSel.addEventListener('change', function() {
          renderCitiesForProvince(this.value);
          renderTableRows();
        });

        // Select all / deselect all buttons
        const selectAllBtn = document.getElementById('select-all-cities');
        const deselectAllBtn = document.getElementById('deselect-all-cities');
        if (selectAllBtn) selectAllBtn.addEventListener('click', function() {
          document.querySelectorAll('#city-items .city-checkbox').forEach(cb => { cb.checked = true; });
          renderTableRows();
        });
        if (deselectAllBtn) deselectAllBtn.addEventListener('click', function() {
          document.querySelectorAll('#city-items .city-checkbox').forEach(cb => { cb.checked = false; });
          renderTableRows();
        });

        // Reset button: clear selections and clear table inputs
        const resetBtn = document.getElementById('reset-button');
        if (resetBtn) resetBtn.addEventListener('click', function() {
          document.querySelectorAll('#city-items .city-checkbox').forEach(cb => { cb.checked = false; });
          renderTableRows();
        });

        // Form submit: serialize table rows into hidden input as JSON
        const manualForm = document.getElementById('manual-form');
        if (manualForm) {
          manualForm.addEventListener('submit', function(e) {
            const rows = (function collectRowsData() {
              const out = [];
              const tbody = document.querySelector('#manual-section table tbody');
              if (!tbody) return out;
              tbody.querySelectorAll('tr').forEach(tr => {
                const cityCell = tr.children[0];
                if (!cityCell) return;
                const city = cityCell.textContent.trim();
                // if it's the empty-row message, skip
                if (!city || city === '未找到要录入的城市') return;
                let cursor = 1; // start after city cell
                const groups = [];
                const headerCount = document.querySelectorAll('#manual-section table thead th[data-indicator]').length || 0;
                for (let g = 0; g < headerCount; g++) {
                  const valTd = tr.children[cursor];
                  const noteTd = tr.children[cursor+1];
                  const sourceTd = tr.children[cursor+2];
                    const val = valTd ? (valTd.querySelector('input') ? valTd.querySelector('input').value.trim() : '') : '';
                    const note = noteTd ? (noteTd.querySelector('input') ? noteTd.querySelector('input').value.trim() : '') : '';
                    const source = sourceTd ? (sourceTd.querySelector('select') ? sourceTd.querySelector('select').value : '') : '';
                    const refTd = tr.children[cursor+3];
                    const reference = refTd ? (refTd.querySelector('input') ? refTd.querySelector('input').value.trim() : (refTd.textContent || '').trim()) : '';
                    groups.push({ value: val, note: note, source: source, reference: reference });
                    cursor += 4; // skip the last-year reference cell
                }
                out.push({ city: city, groups: groups });
              });
              return out;
            })();

            if (!rows || rows.length === 0) {
              e.preventDefault();
              alert('请先选择一个或多个城市，再提交数据。');
              return false;
            }

            const hidden = document.getElementById('rows-json');
            if (hidden) hidden.value = JSON.stringify(rows);
            // allow form to submit normally
            e.preventDefault();
            // 获取表单数据
            const formData = new FormData(this);
            
            // 显示加载状态
            const submitBtn = document.getElementById('submit-button');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '提交中...';
            submitBtn.disabled = true;

            // 提交表单
            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // alert('✅ 提交成功！');
                    showAutoCloseMessage('✅ 提交成功！', 'success');
                    setTimeout(() => {
                        window.location.reload(); // 刷新页面
                    }, 500);
                } else {
                    alert('❌ 提交失败：' + data.message);
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('错误:', error);
                alert('❌ 网络错误');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });

          });
        }

        // Listen for city checkbox changes (delegated)
        document.addEventListener('change', function(e) {
          if (e.target && e.target.classList && e.target.classList.contains('city-checkbox')) {
            renderTableRows();
          }
        });

        // initial table render
        renderTableRows();
      });
    })();

    // 选项卡切换功能
    document.getElementById('manual-tab').addEventListener('click', function() {
      document.getElementById('manual-section').classList.remove('hidden');
      document.getElementById('excel-section').classList.add('hidden');
      this.classList.add('text-white', 'border-yellow-500');
      document.getElementById('excel-tab').classList.remove('text-white', 'border-yellow-500');
      document.getElementById('excel-tab').classList.add('text-gray-400');
      attachProgressListeners();
      updateProgress();
    });

    // 提示框
    // 创建自动消失的提示消息函数
function showAutoCloseMessage(message, type = 'success') {
    // 移除已有的消息
    const existingMsg = document.querySelector('.auto-close-message');
    if (existingMsg) existingMsg.remove();
    
    // 创建消息元素
    const msgDiv = document.createElement('div');
    msgDiv.className = 'auto-close-message fixed top-6 left-1/2 transform -translate-x-1/2 px-6 py-4 rounded-lg shadow-lg z-50';
    
    // 根据类型设置样式
    if (type === 'success') {
        msgDiv.className += ' bg-green-600 text-white border-l-4 border-green-400';
    } else {
        msgDiv.className += ' bg-red-600 text-white border-l-4 border-red-400';
    }
    
    // 添加图标和消息
    msgDiv.innerHTML = `
        <div class="flex items-center">
            <iconify-icon icon="${type === 'success' ? 'mdi:check-circle' : 'mdi:alert-circle'}" 
                class="text-2xl mr-3"></iconify-icon>
            <span class="text-lg font-medium">${message}</span>
        </div>
    `;
    
    // 初始状态：隐藏在上方
    msgDiv.style.opacity = '0';
    msgDiv.style.transform = 'translateX(-50%) translateY(-30px)';
    msgDiv.style.transition = 'all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55)';
    
    // 添加到页面
    document.body.appendChild(msgDiv);
    
    // 触发入场动画
    setTimeout(() => {
        msgDiv.style.opacity = '1';
        msgDiv.style.transform = 'translateX(-50%) translateY(0)';
    }, 10);
    
    // 3秒后开始消失动画
    setTimeout(() => {
        // 离场动画
        msgDiv.style.opacity = '0';
        msgDiv.style.transform = 'translateX(-50%) translateY(-20px) scale(0.95)';
        
        // 动画完成后移除元素
        setTimeout(() => {
            if (msgDiv.parentNode) {
                msgDiv.parentNode.removeChild(msgDiv);
            }
        }, 400); // 与transition时间匹配
    }, 3000); // 总共显示3秒（入场+停留）
}

    
    
    
    document.getElementById('excel-tab').addEventListener('click', function() {
      document.getElementById('excel-section').classList.remove('hidden');
      document.getElementById('manual-section').classList.add('hidden');
      this.classList.add('text-white', 'border-yellow-500');
      document.getElementById('manual-tab').classList.remove('text-white', 'border-yellow-500');
      document.getElementById('manual-tab').classList.add('text-gray-400');
    });

    // 指标筛选功能
    const indicatorFilter = document.getElementById('indicator-filter');
    // const indicatorCategories = {
    //   'population': ['常住人口数', '城镇人口数', '乡村人口数', '户籍人口数', '年末总人口', '年末总户数', '15-19岁人口数', '60岁以上人口数'],
    //   'enterprise': ['年末个体工商户数量', '年末内资企业数', '年末外资企业数', '年末私营企业数'],
    //   'technology': ['高新技术企业产值', '高新技术企业增加值', '技术合同成交额（交易额）', '有效发明专利量（发明专利有效量）', '每万人发明专利拥有量', '专利授权数量'],
    //   'employment': ['采矿（掘)业就业人员人数', '制造业就业人员人数', '采矿（掘)业在岗职工人数', '制造业在岗职工人数'],
    //   'budget': ['一般公共预算支出', '一般公共服务支出', '科学技术支出', '公共安全支出', '文化体育传媒支出', '环保支出', '社会保障和就业支出', '教育支出', '医疗卫生支出']
    // };
    const indicatorCategories = {
      'admin': ['#市数量', '#区数量', '#县数量', '#辖区面积'],
      'population': ['#常住人口数', '#城镇人口数', '#乡村人口数', '#户籍人口数', '#年末总人口', '#年末总户数', '#15-19岁人口数', '#60岁以上人口数', '#出生人口性别比', '#人口出生率'],
      'economy_structure': ['#年末个体工商户数量', '#年末内资企业数', '#年末外资企业数', '#年末私营企业数', '#高新技术企业产值', '#高新技术企业增加值', '#技术合同成交额（交易额）', '#技术合同成交额（交易额）增长率', '#国有资产保值增值率', '#第二产业增加值占GDP（增量）比重', '#第三产业增加值占GDP（增量）比重'],
      'education_tech': ['#有效发明专利量（发明专利有效量）', '#每万人发明专利拥有量', '#专利授权数量', '#普通小学专任教师数', '#普通中学专任教师数', '#普通小学在校学生数', '#普通中学在校学生数', '#高中学在校学生数', '#R&D经费'],
      'employment': ['#采矿（掘)业就业人员人数', '#制造业就业人员人数', '#采矿（掘)业在岗职工人数', '#制造业在岗职工人数', '#城镇单位职工工资总额', '#城镇就业人数（城镇单位职工总数（城镇单位就业人数+城镇私营就业人数））', '#社会从业人员', '#机关单位工资总额', '#机关单位就业人数', '#公共管理、社会保障和社会组织工资总额', '#公共管理、社会保障和社会组织在岗职工人数'],
      'finance': ['#一般公共预算支出', '#一般公共服务支出', '#科学技术支出', '#公共安全支出', '#文化体育传媒支出', '#环保支出', '#社会保障和就业支出', '#教育支出', '#医疗卫生支出'],
      'economic_performance': ['#城镇居民人均消费支出', '#城镇食品支出', '#农村居民人均消费支出', '#农村食品支出', '#城镇恩格尔系数', '#农村恩格尔系数', '#城镇登记失业人员数', '#城镇登记失业率', '#能源消耗总量', '#万元GDP综合能源消耗', '#城镇化率', '#城镇居民人均可支配收入', '#城镇居民人均可支配收入增长率', '#农民居民人均可支配收入', '#农民居民人均可支配收入增长率'],
      'ecology': ['#园林绿地面积', '#二氧化硫排放总量', '#工业二氧化硫排放量', '#森林覆盖率', '#水土流失治理面积', '#工业废水排放总量', '#工业固体废弃物综合利用率', '#生活垃圾无害化处理率', '#城镇生活污水处理率', '#城市空气质量指数', '#城市区域环境噪音指数（市区区域环境噪音平均等效声级值）', '#PM2.5', '#PM10'],
      'market_supervision': ['#查出不正当竞争案件数', '#生产安全事故死亡人数', '#工矿商贸死亡人数', '#亿元GDP生产安全事故死亡率', '#十万人工矿商贸从业人员事故死亡率', '#食品质量抽样检测合格率', '#药品安全抽样合格率', '#工业产品质量抽样合格率', '#查处农资违法案件的数量', '#查办违法广告的件数', '#查办商标侵权案件的件数', '#受理消费者维权案件数', '#受理消费者投诉案件数', '#消费者维权案件办理率'],
      'social_security': ['#城镇职工基本养老保险人数', '#城乡居民基本养老保险人数', '#城镇职工基本医疗保险人数', '#城乡居民基本医疗保险人数', '#城镇最低生活保障人数', '#农村最低生活保障人数', '#年末实有社会组织登记数量', '#养老机构床位数', '#城镇新增就业人数', '#新建保障性住房套数'],
      'healthcare': ['#卫生技术人员数量', '#医疗机构病床数'],
      'infrastructure': ['#有线电视用户数', '#固定宽带互联网用户数', '#自来水受益村数', '#村委会个数'],
      'public_safety': ['#刑事案件立案件数', '#刑事案件破案件数', '#受理信访举报案件数', '#调处各类矛盾纠纷件数', '#成功调处各类矛盾纠纷数', '#受理各类法律援助案件的数量', '#火灾死亡人数', '#接待群众来信来访人次'],
      'culture_sports': ['#文化馆、群众艺术馆', '#博物馆', '#艺术表演团体', '#体育场馆', '#公共图书馆'],
      'administrative_integrity': ['#贪污贿赂人数', '#渎职侵权人数', '#立案查处违法违纪案件数', '#被依法追究责任的领导干部人数'],
      'economic_growth': ['#GDP', '#人均GDP', '#GDP增长率', '#一般公共预算收入', '#财政总收入', '#财政总收入增长率', '#固定资产投资总额', '#固定资产投资总额增长率', '#全社会消费品零售总额', '#全社会消费品零售总额增长率', '#进出口总额', '#进出口总额增长率', '#实际利用外资金额', '#实际利用外资金额增长率', '#规模以上工业企业增加值'],
      'economic_development': ['#居民消费价格指数CPI', '#工业品出厂价格指数PPI'],
      'public_service': ['#人均城市道路面积', '#高中阶段毛入学率'],
      'law_based_governance': ['行政复议案件办结率', '行政复议案件申请量', '行政案件数'],
      'government_affairs_openness': ['主动公开政府信息件数','主动公开政府信息件数备注', '#依申请公开政府信息件数', '依申请公开政府信息件数备注','因公开问题申请行政复议的数量','因公开问题申请行政复议的数量备注']
    };

    // Populate subfilter options when a category (指标组) is chosen.
    function populateSubfilter(categoryKey) {
      const sub = document.getElementById('indicator-subfilter');
      if (!sub) return;
      sub.innerHTML = '';
      if (!categoryKey || categoryKey === '') {
        // leave empty so user can choose nothing
        return;
      }
      const items = indicatorCategories[categoryKey] || [];

      // control buttons: 全选 / 取消全选
      const ctrlDiv = document.createElement('div');
      ctrlDiv.className = 'flex justify-end mb-2 space-x-2';
      const btnAll = document.createElement('button');
      btnAll.type = 'button';
      btnAll.className = 'text-xs text-gray-300 hover:text-white';
      btnAll.textContent = '全选';
      const btnNone = document.createElement('button');
      btnNone.type = 'button';
      btnNone.className = 'text-xs text-gray-300 hover:text-white';
      btnNone.textContent = '取消全选';
  ctrlDiv.appendChild(btnAll);
  ctrlDiv.appendChild(btnNone);
      sub.appendChild(ctrlDiv);

  const listDiv = document.createElement('div');
  // ensure a single vertical column (no auto-wrapping into multiple columns)
  listDiv.className = 'flex flex-col space-y-2';

      items.forEach((i, idx) => {
        const label = ('' + i).replace(/^#/, '');
        const id = 'indicator-' + categoryKey + '-' + idx;
  const row = document.createElement('div');
  // full width row so items never wrap into multiple horizontal columns
  row.className = 'flex items-center w-full';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.className = 'indicator-checkbox rounded border-gray-600 text-yellow-500';
        input.value = label;
        input.id = id;
  const lab = document.createElement('label');
  lab.htmlFor = id;
  // prevent label text from wrapping; truncate with ellipsis if too long
  lab.className = 'ml-2 text-white text-sm truncate';
  lab.textContent = label;
  lab.title = label;
        row.appendChild(input);
        row.appendChild(lab);
        listDiv.appendChild(row);
      });

      sub.appendChild(listDiv);

      // attach control actions
      btnAll.addEventListener('click', function() {
        sub.querySelectorAll('.indicator-checkbox').forEach(cb => cb.checked = true);
        // trigger header/body rebuild
        const selected = Array.from(sub.querySelectorAll('.indicator-checkbox:checked')).map(n => n.value);
        if (window.buildTableHeaders) window.buildTableHeaders(selected);
        if (window.renderTableRows) window.renderTableRows();
      });
      btnNone.addEventListener('click', function() {
        sub.querySelectorAll('.indicator-checkbox').forEach(cb => cb.checked = false);
        if (window.buildTableHeaders) window.buildTableHeaders([]);
        if (window.renderTableRows) window.renderTableRows();
      });
    }

    indicatorFilter.addEventListener('change', function() {
      const selectedCategory = this.value;
      const sub = document.getElementById('indicator-subfilter');
      if (!sub) return;
      if (selectedCategory === '') {
        // restore initial headers and clear subfilter
        sub.innerHTML = '';
        if (window.buildTableHeaders) window.buildTableHeaders(window.initialIndicators || []);
        if (window.renderTableRows) window.renderTableRows();
        return;
      }

      // Fill the secondary panel but do NOT immediately rebuild headers.
      populateSubfilter(selectedCategory);
      // With no subfilter selection, the manual table should not show indicator columns
      if (window.buildTableHeaders) window.buildTableHeaders([]);
      if (window.renderTableRows) window.renderTableRows();
    });

    // Delegate change events: handle indicator-checkbox changes to rebuild headers
    document.addEventListener('change', function(e) {
      if (e.target && e.target.classList && e.target.classList.contains('indicator-checkbox')) {
        const sub = document.getElementById('indicator-subfilter');
        const selected = sub ? Array.from(sub.querySelectorAll('.indicator-checkbox:checked')).map(n => n.value) : [];
        if (!selected || selected.length === 0) {
          if (window.buildTableHeaders) window.buildTableHeaders([]);
          if (window.renderTableRows) window.renderTableRows();
          return;
        }
        if (window.buildTableHeaders) window.buildTableHeaders(selected);
        if (window.renderTableRows) window.renderTableRows();
      }
    });

    // Default: select 'admin' group and populate subfilter, but DO NOT auto-check indicators
    (function setDefaultIndicatorGroup() {
      const defaultGroup = 'admin';
      if (indicatorFilter) indicatorFilter.value = defaultGroup;
      // populate checkboxes but do not select any — user must choose
      populateSubfilter(defaultGroup);
      // leave headers empty until user explicitly checks indicators
      if (window.buildTableHeaders) window.buildTableHeaders([]);
      if (window.renderTableRows) window.renderTableRows();
    })();
  </script>
</body>
</html>
